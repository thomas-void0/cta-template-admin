ARG NAME=node
ARG VERSION=18.14-alpine
ARG PROXY=nginx
ARG PROXY_VERSION=1.22.1

FROM ${NAME}:${VERSION} as deps
WORKDIR /workspace
RUN npm install -g pnpm
COPY pnpm-lock.yaml .npmrc ./
RUN pnpm fetch
COPY package.json ./
RUN pnpm install --frozen-lockfile --offline --ignore-scripts

FROM ${NAME}:${VERSION} as builder
WORKDIR /workspace
RUN npm install -g pnpm
COPY --from=deps /workspace/node_modules ./node_modules
COPY . .
RUN pnpm build

FROM ${PROXY}:${PROXY_VERSION} as runer
LABEL maintainer="thomas-void0 <yjy15680489038@163.com>"
WORKDIR /
COPY --from=builder /workspace/dist/ /usr/share/nginx/html/
RUN rm /etc/nginx/conf.d/default.conf
COPY --from=builder /workspace/nginx.conf /etc/nginx/conf.d/

